

services:
  # Databases
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: haunted
      POSTGRES_PASSWORD: haunted_dev_pass
      POSTGRES_DB: haunted
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./demo/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U haunted"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Unleash for feature flags
  unleash-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: unleash
      POSTGRES_USER: unleash
      POSTGRES_PASSWORD: unleash_pass
    volumes:
      - unleash-db-data:/var/lib/postgresql/data

  unleash:
    image: unleashorg/unleash-server:latest
    ports:
      - "4242:4242"
    environment:
      DATABASE_URL: postgres://unleash:unleash_pass@unleash-db:5432/unleash
      DATABASE_SSL: "false"
      INIT_ADMIN_API_TOKENS: "*:*.unleash-insecure-api-token"
      INIT_CLIENT_API_TOKENS: "*:*.unleash-insecure-api-token"
    depends_on:
      - unleash-db
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4242/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Backend Services
  user-auth-service:
    build:
      context: ./app/services/user-auth-service
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
    environment:
      GRPC_PORT: 50051
      DATABASE_URL: postgresql://haunted:haunted_dev_pass@postgres:5432/haunted?sslmode=disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_PRIVATE_KEY_PATH: /app/keys/jwt-private.pem
      JWT_PUBLIC_KEY_PATH: /app/keys/jwt-public.pem
      BCRYPT_COST: 12
      LOG_LEVEL: info
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./keys:/app/keys:ro

  billing-service:
    build:
      context: ./app/services/billing-service
      dockerfile: Dockerfile
    ports:
      - "50052:50052"
      - "8080:8080"
    environment:
      GRPC_PORT: 50052
      HTTP_PORT: 8080
      DATABASE_URL: postgresql://haunted:haunted_dev_pass@postgres:5432/haunted?sslmode=disable
      STRIPE_API_KEY: ${STRIPE_API_KEY:-sk_test_placeholder}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_placeholder}
      LOG_LEVEL: info
    depends_on:
      postgres:
        condition: service_healthy

  llm-gateway-service:
    build:
      context: ./app/services/llm-gateway-service
      dockerfile: Dockerfile
    ports:
      - "50053:50053"
    environment:
      GRPC_PORT: 50053
      PROMPTS_DIR: /app/prompts
      WATCH_PROMPTS: "true"
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-placeholder}
      DEFAULT_PROVIDER: openai
      DEFAULT_MODEL: gpt-4-turbo-preview
      DEFAULT_TIMEOUT_SECONDS: 30
      ANALYTICS_SERVICE_ADDR: analytics-service:50054
      LOG_LEVEL: info
    volumes:
      - ./prompts:/app/prompts:ro
    depends_on:
      - analytics-service

  notifications-service:
    build:
      context: ./app/services/notifications-service
      dockerfile: Dockerfile
    ports:
      - "50054:50054"
      - "3002:3002"
    environment:
      GRPC_PORT: 50054
      SOCKETIO_PORT: 3002
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-change-in-production}
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:3001
      MAX_CONNECTIONS: 10000
      LOG_LEVEL: info
    depends_on:
      redis:
        condition: service_healthy

  analytics-service:
    build:
      context: ./app/services/analytics-service
      dockerfile: Dockerfile
    ports:
      - "50055:50055"
    environment:
      GRPC_PORT: 50055
      DATABASE_URL: postgresql://haunted:haunted_dev_pass@postgres:5432/haunted?sslmode=disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_CACHE_TTL: 300
      LOG_LEVEL: info
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  feature-flags-service:
    build:
      context: ./app/services/feature-flags-service
      dockerfile: Dockerfile
    ports:
      - "50056:50056"
    environment:
      GRPC_PORT: 50056
      UNLEASH_URL: http://unleash:4242/api
      UNLEASH_API_TOKEN: "*:*.unleash-insecure-api-token"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ANALYTICS_SERVICE_URL: analytics-service:50055
      AUTH_SERVICE_URL: user-auth-service:50051
      RBAC_ENABLED: "true"
      LOG_LEVEL: info
    depends_on:
      unleash:
        condition: service_healthy
      redis:
        condition: service_healthy

  # GraphQL API Gateway
  graphql-gateway:
    build:
      context: ./app
      dockerfile: gateway/Dockerfile
    ports:
      - "4000:4000"
    environment:
      PORT: 4000
      USER_AUTH_SERVICE: user-auth-service:50051
      BILLING_SERVICE: billing-service:50052
      LLM_GATEWAY_SERVICE: llm-gateway-service:50053
      NOTIFICATIONS_SERVICE: notifications-service:50054
      ANALYTICS_SERVICE: analytics-service:50055
      FEATURE_FLAGS_SERVICE: feature-flags-service:50056
      JWT_PUBLIC_KEY_PATH: /app/keys/jwt-public.pem
      LOG_LEVEL: info
    depends_on:
      - user-auth-service
      - billing-service
      - llm-gateway-service
      - notifications-service
      - analytics-service
      - feature-flags-service
    volumes:
      - ./keys:/app/keys:ro

  # Frontend
  frontend:
    build:
      context: ./app/frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_GRAPHQL_URL: http://localhost:4000/graphql
      NEXT_PUBLIC_SOCKETIO_URL: http://localhost:3002
    depends_on:
      - graphql-gateway

  # Documentation (run locally with: cd docs && npm install && npm start)
  # docs:
  #   build:
  #     context: ./docs
  #     dockerfile: Dockerfile
  #   ports:
  #     - "3001:3000"

volumes:
  postgres-data:
  redis-data:
  unleash-db-data:
